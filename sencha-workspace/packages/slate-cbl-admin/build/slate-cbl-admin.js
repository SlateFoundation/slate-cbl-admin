Ext.define("Slate.cbl.admin.overrides.SettingsNavPanel",{override:"SlateAdmin.view.settings.NavPanel",initComponent:function(){var a=this;a.data=a.data.concat({href:"#settings/cbl/skills",text:"CBL Skills"});a.callParent(arguments)}});Ext.define("Slate.cbl.admin.view.skills.Grid",{extend:"Ext.grid.Panel",requires:["Ext.toolbar.Paging"],xtype:"cbl-admin-skills-grid",store:"Skills",height:"100%",dockedItems:[{xtype:"pagingtoolbar",store:"Skills",dock:"bottom",displayInfo:true}],columns:{defaults:{flex:1},items:[{dataIndex:"Code",text:"Code"},{dataIndex:"Descriptor",text:"Descriptor",flex:5,editor:{xtype:"textfield",allowBlank:false}},{dataIndex:"Statement",text:"Statement",flex:5,editor:{xtype:"textfield",allowBlank:false}}]}});Ext.define("Slate.cbl.admin.view.skills.EvidenceRequirementsField",{extend:"Ext.form.FieldContainer",xtype:"cbl-admin-skills-evidencerequirementsfield",requires:["Ext.form.field.Number","Ext.layout.container.HBox"],layout:"hbox",fieldLabel:"",config:{level:"default",value:0},initComponent:function(){var a=this,b=a.getLevel();a.items=[{xtype:"numberfield",fieldLabel:(b=="default"?"Default Level":"Level "+b),value:a.getValue(),minValue:0,listeners:{change:function(c,d){this.up("cbl-admin-skills-evidencerequirementsfield").setValue(d)}}}];if(b!=="default"){a.items.push({xtype:"button",cls:"glyph-danger",glyph:61526,text:"Remove",handler:function(){this.up("fieldcontainer").destroy()}})}a.callParent(arguments)}});Ext.define("Slate.cbl.admin.view.skills.Form",{extend:"Ext.form.Panel",xtype:"cbl-admin-skills-form",requires:["Ext.form.field.ComboBox","Ext.form.field.Display","Ext.form.field.Number","Ext.form.field.Text","Ext.form.field.TextArea","Ext.panel.Panel","Ext.toolbar.Fill","Slate.cbl.admin.view.skills.EvidenceRequirementsField"],disabled:true,title:"Selected Skill",componentCls:"cbl-admin-skills-editor",bodyPadding:10,scrollable:"vertical",trackResetOnLoad:true,defaults:{labelWidth:70,labelAlign:"right",anchor:"100%"},items:[{xtype:"displayfield",name:"Code",fieldLabel:"Code"},{xtype:"textfield",name:"Descriptor",fieldLabel:"Descriptor",allowBlank:false},{xtype:"textareafield",name:"Statement",fieldLabel:"Statement",allowBlank:false,grow:true},{xtype:"panel",itemId:"evidence-requirements-container",title:"Evidence Requirements",tbar:[{xtype:"numberfield",fieldLabel:"Level",minValue:1,isFormField:false,listeners:{change:function(){this.next("button").setDisabled(!this.getValue())}}},{xtype:"tbfill"},{text:"Add Level",action:"add",disabled:true,glyph:61525,cls:"glyph-success",handler:function(){var a=this.up("form"),b=this.prev("numberfield"),c=b.getValue();if(Ext.isNumeric(c)){a.fireEvent("addevidencerequirementlevel",a,b,c)}}}]}],buttons:[{itemId:"revertBtn",disabled:true,text:"Revert Changes",cls:"glyph-danger",glyph:61527},{xtype:"tbfill"},{itemId:"saveBtn",disabled:true,text:"Save Changes",cls:"glyph-success",glyph:61528}],loadRecord:function(a){var f=this,c=f.down("#evidence-requirements-container"),e=0,b=[],d;c.removeAll();if(a&&(e=a.get("DemonstrationsRequired"))){for(d in e){if(e.hasOwnProperty(d)){b.push(Ext.factory({level:d,value:e[d]},"Slate.cbl.admin.view.skills.EvidenceRequirementsField"))}}}c.add(b);f.callParent(arguments)},getEvidenceRequirements:function(e){var d=this,a={},c=d.query("cbl-admin-skills-evidencerequirementsfield"),b=0;for(;b<c.length;b++){a[c[b].getLevel()]=c[b].getValue()}if(e){return a[e]}return a}});Ext.define("Slate.cbl.admin.view.skills.Manager",{extend:"Ext.Container",xtype:"cbl-admin-skills-manager",requires:["Slate.cbl.admin.view.skills.Grid","Slate.cbl.admin.view.skills.Form"],layout:"border",items:[{region:"west",split:true,xtype:"cbl-admin-skills-grid",autoScroll:true,width:500},{region:"center",xtype:"cbl-admin-skills-form",flex:1}]});Ext.define("Slate.cbl.admin.model.Skill",{extend:"Ext.data.Model",requires:["Slate.proxy.Records","Ext.data.identifier.Negative"],idProperty:"ID",identifier:"negative",fields:[{name:"ID",type:"int",allowNull:true},{name:"Class",type:"string",defaultValue:"Slate\\CBL\\Skill"},{name:"Created",type:"date",dateFormat:"timestamp",allowNull:true},{name:"CreatorID",type:"int",allowNull:true},{name:"RevisionID",type:"int",allowNull:true},{name:"Modified",type:"date",dateFormat:"timestamp",allowNull:true},{name:"ModifierID",type:"int",allowNull:true},{name:"CompetencyID",type:"int"},{name:"Code",type:"string"},{name:"Descriptor",type:"string"},{name:"Statement",type:"string"},"DemonstrationsRequired"],proxy:{type:"slate-records",url:"/cbl/skills"}});Ext.define("Slate.cbl.admin.store.Skills",{extend:"Ext.data.Store",model:"Slate.cbl.admin.model.Skill",remoteSort:true,pageSize:50});Ext.define("Slate.cbl.admin.controller.Skills",{extend:"Ext.app.Controller",views:["skills.Manager@Slate.cbl.admin.view"],stores:["Skills@Slate.cbl.admin.store"],refs:{skillsManager:{selector:"cbl-admin-skills-manager",autoCreate:true,xtype:"cbl-admin-skills-manager"},skillsGrid:{selector:"cbl-admin-skills-grid",autoCreate:true,xtype:"cbl-admin-skills-grid"},skillsForm:{selector:"cbl-admin-skills-form",autoCreate:true,xtype:"cbl-admin-skills-form"},evidenceRequirementCt:"#evidence-requirements-container",saveBtn:"cbl-admin-skills-form #saveBtn",revertBtn:"cbl-admin-skills-form #revertBtn",addLevelBtn:"cbl-admin-skills-form button[action=add]",settingsNavPanel:"settings-navpanel"},control:{skillsGrid:{select:"onSkillSelect"},skillsForm:{addevidencerequirementlevel:"addEvidenceRequirementLevel",dirtychange:"onFormDirtyChange"},saveBtn:{click:"onSaveSkillClick"},revertBtn:{click:"onRevertChangesClick"},"cbl-admin-skills-evidencerequirementsfield":{destroy:"onEvidenceRequirementsFieldDestroyed"}},routes:{"settings/cbl/skills":"showSkills"},showSkills:function(){var d=this,c=d.getSkillsManager(),b=d.getSkillsGrid(),a=d.getSettingsNavPanel();Ext.suspendLayouts();Ext.util.History.suspendState();a.setActiveLink("settings/cbl/skills");a.expand();Ext.util.History.resumeState(false);d.getApplication().getController("Viewport").loadCard(c);b.getStore().load();Ext.resumeLayouts(true)},onSkillSelect:function(){var d=this,c=d.getSkillsForm(),b=d.getSkillsGrid(),a=b.getSelectionModel().getSelection()[0];c.enable();c.loadRecord(a);c.setTitle(a.get("Code"));if(a.isPhantom){a.set("DemonstrationsRequired",[])}d.syncFormButtons()},onSaveSkillClick:function(){var c=this,b=c.getSkillsForm(),a=b.getRecord();b.updateRecord(a);a.set("DemonstrationsRequired",b.getEvidenceRequirements());if(a.dirty){b.setLoading("Saving skill&hellip;");a.save({callback:function(d,e,f){b.setLoading(false);if(f){b.loadRecord(d)}else{Ext.Msg.alert("Failed to save skill","This skill failed to save to the server:<br><br>"+(e.getError()||"Unknown reason, try again or contact support"))}}})}},onFormDirtyChange:function(b,a){this.syncFormButtons()},syncFormButtons:function(){var f=this,e=f.getSkillsForm(),d=e.isDirty(),c=f.getRevertBtn(),g=f.getSaveBtn(),a=f.getAddLevelBtn(),b=JSON.stringify(e.getRecord().get("DemonstrationsRequired"))!==JSON.stringify(e.getEvidenceRequirements());a.setDisabled(!Ext.isNumeric(a.prev("numberfield").getValue()));c.setDisabled(!d&&!b);g.setDisabled(!d&&!b)},onRevertChangesClick:function(b){var a=this.getSkillsForm();a.reset();a.loadRecord(a.getRecord());this.syncFormButtons()},onEvidenceRequirementsFieldDestroyed:function(){this.syncFormButtons()},addEvidenceRequirementLevel:function(d,f,g){var c=this,e=c.getEvidenceRequirementCt(),b=d.getEvidenceRequirements(),a=0;if(b[g]!==undefined){return Ext.Msg.alert("Error","This level already exists. Please select another level.")}b[g]=true;a=Object.keys(b).sort(function(i,h){if(Ext.isNumeric(i)&&Ext.isNumeric(h)){return parseInt(i,10)-parseInt(h,10)}else{if(Ext.isNumeric(i)){return -1}else{if(Ext.isNumeric(h)){return 1}else{return 0}}}}).indexOf(g.toString());e.insert(a,{xtype:"cbl-admin-skills-evidencerequirementsfield",level:g});f.reset();this.syncFormButtons()}});Ext.define("Slate.cbl.admin.overrides.SlateAdmin",{override:"SlateAdmin.Application",requires:["Slate.cbl.admin.controller.Skills"],initControllers:function(){this.callParent();this.getController("Slate.cbl.admin.controller.Skills")}});